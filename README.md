<img width="1600" height="720" alt="thumb" src="https://github.com/user-attachments/assets/011f1b9f-25db-4ad2-b0dc-7362bbf4f2a7" />

鳴花ミコト「なんか動いた」  
鳴花ヒメ「こわ～」

（これは α 版です）

# lab2layer-ae

After Effects 用の音素リップシンクツール

音素タイミングファイルを解析して音素レイヤーを生成し、不透明度エクスプレッションを一括設定します

## 概要

lab2layer は、音声合成ソフトが出力する lab ファイルを読み込み、After Effects で口パク（リップシンク）アニメーションを簡単に作成するためのスクリプトです

lab ファイルの構造が独自的で特殊だと動かない可能性があります（NEUTRINO なら `full.lab` ではなく `timing.lab` を使うなどなど）

## 機能

- **lab ファイルの解析**: lab ファイルから音素とタイミング情報を自動抽出
- **音素レイヤーの生成**: マーカー付きのヌルレイヤーを自動作成
- **不透明度エクスプレッション**: 選択したレイヤーに音素連動の不透明度エクスプレッションを自動設定
- **音素フィルタリング**: 必要な音素のみを選択して使用可能
- **複数音素対応**: レイヤー名にカンマ区切りで複数の音素を指定可能

## インストール方法

1. `lab2layer.jsx` をダウンロード
2. 以下のいずれかの場所に配置:
   - **Windows**: `C:\Program Files\Adobe\Adobe After Effects <version>\Support Files\Scripts\ScriptUI Panels\`
   - **macOS**: `/Applications/Adobe After Effects <version>/Scripts/ScriptUI Panels/`
3. After Effects を再起動
4. メニューから `ウィンドウ` → `lab2layer.jsx` を選択

> [!NOTE]
> mac 環境での動作チェックはしていないので動かなかったら改変してください

## 使用例

1. VOICEVOX で「こんにちは」を書き出して、.lab ファイルを作る  
   ※設定で [lab ファイルを一緒に書き出す](https://voicevox.hiroshiba.jp/how_to_use/#:~:text=lab%20%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E6%9B%B8%E3%81%8D%E5%87%BA%E3%81%97) 方法
2. 「Browse...」で lab ファイルを読み込む
3. 使用したい音素にチェック  
   （基本はデフォルトの「Common」で OK。多くても閉じ口がわかりやすい s、m、r、w あたりにとどめておくとよさげ）

   > [x] a(1) [x] i(2) [x] o(1)  
   > [x] N(1) [x] pau(2) [ ] k(1)  
   > [ ] n(1) [ ] ch(1) [ ] w(1)

4. 口パク画像のあるコンポジション内で、再生ヘッドをセリフの開始位置に移動し、「Create Phoneme Layer」で音素レイヤーを配置
5. 口パク画像のレイヤー名を、表示したい音素名に変更

   - 閉じ口.png → レイヤー名: sil,N,cl
   - あ.png → レイヤー名: a
   - い.png → レイヤー名: i
   - お.png → レイヤー名: o,u

6. 変更した口パク画像のレイヤーを全選択 → 「Setup Opacity」でリアルタイム不透明度を設定

> [!NOTE]
> Phoneme レイヤーをドラッグしてオフセット（開始位置）を調整します。音声が聞こえる数フレーム前にすると自然に見えます

## 詳細な使い方

### Step 1: lab ファイルの読み込み

1. スクリプトパネルを開く
2. 「Browse...」ボタンをクリック
3. lab ファイル（`.lab`）を選択
4. 解析された音素がチェックボックス付きで表示される

### Step 2: 音素の選択

| ボタン     | 説明                           |
| ---------- | ------------------------------ |
| **All**    | すべての音素を選択             |
| **None**   | すべての選択を解除             |
| **Common** | よく使われている音素を自動選択 |

### Step 3: Phoneme レイヤーの作成

1. 使用する音素にチェックを入れる
2. タイムラインでセリフの開始位置に再生ヘッドを移動
3. 「Create Phoneme Layer」ボタンをクリック
4. 「Phoneme」という名前のヌルレイヤーが作成され、各音素がマーカーとして配置される

複数セリフの場合、各セリフごとに上記の手順を繰り返すことで、複数の Phoneme レイヤーを配置できます

現在時刻に有効なレイヤーのうち、一番上にあるものが参照される仕様です

### Step 4: 口パク画像の準備

各音素に対応する画像レイヤーを用意し、**レイヤー名を音素名に設定**します

```
// 一例
- あ.png  → レイヤー名: a
- い.png  → レイヤー名: i
- う.png  → レイヤー名: u,w
- え.png  → レイヤー名: e
- お.png  → レイヤー名: o
- 閉じ.png  → レイヤー名: N,sil,pau,def
   ⋮
```

> [!NOTE]
> 音素レイヤーがないときは「def」を含むレイヤーが表示されます。指定がなければ何も表示されません

#### 複数音素を同じ画像で表示する場合

レイヤー名にカンマ区切りで複数の音素を指定できます

```
- a,e.png → レイヤー名: a,e（「あ」と「え」で同じ口の形を使用）
```

### Step 5: 不透明度エクスプレッションの設定

1. 口パク画像レイヤーをすべて選択
2. 「Setup Opacity」ボタンをクリック
3. 各レイヤーに不透明度エクスプレッションが自動設定される

<img width="1200" height="484" alt="スクリーンショット 2026-01-10 195327" src="https://github.com/user-attachments/assets/f267d0d3-8afd-44a5-a993-3777abdd3189" />

**エクスプレッションの仕組み:**

- Phoneme レイヤーのマーカーから現在の音素を取得
- レイヤー名と音素が一致したら不透明度 100、それ以外は 0
- カンマ区切りで複数音素に対応（例: `a,e` のレイヤーは a か e のときに表示）

## 音素について

**このスクリプトは特定の音素リストを持っていません。**  
lab ファイルから動的に音素を読み取るため、どんな音素でも対応可能です（たぶん maybe おそらく）

- **母音**: a, i, u, e, o
- **特殊**: N (ん), cl (っ), pau (ポーズ), sil (無音) 、br (ブレス)
- **子音**: k, s, t, n, h, m, y, r, w, g, z, d, b, p など

## lab ファイルってなに？

lab ファイルは以下のように 3 つに区分けされた形式のテキストファイルです

```
0 1000000 sil
1000000 2500000 k
2500000 5000000 o
5000000 7500000 N
7500000 10000000 n
10000000 12500000 i
12500000 15000000 ch
15000000 17500000 i
17500000 20000000 w
20000000 22500000 a
22500000 30000000 sil
```

- 1 列目 → 開始時間（100 ナノ秒単位）
- 2 列目 → 終了時間（100 ナノ秒単位）
- 3 列目 → 音素

## 対応ソフトウェア

上のような、単純な形式の音素ファイルなら対応しています

すなわち、以下ソフトウェアが出力する lab ファイルにも対応しているはずです

- VOICEVOX
- NEUTRINO
- CeVIO
- A.I.VOICE
- その他 lab 形式を出力するソフトウェア

## トラブルシューティング

### 「Phoneme layer not found!」エラー

先に「Create Phoneme Layer」ボタンで Phoneme レイヤーを作成してください

### 口パクが反映されない

レイヤー名が音素名と一致しているか確認してください（大文字小文字も区別されます）

### lab ファイルが読み込めない

ファイルの文字コードが UTF-8 または Shift-JIS であることを確認してください

### 音素レイヤーがないときに何も表示されない

閉じレイヤーなどに「def」を追加してください。一応 pau や sil とは区別しています

## ライセンス

MIT License

## バージョン履歴

### v0.1.1

とりあえず動くらしい

- lab ファイル解析機能
- 音素レイヤー生成機能
- 不透明度エクスプレッション自動設定機能

### v0.2.0

- 別ウィンドウに表示されてしまう問題を修正
- ウィンドウサイズで UI を可変表示

### v0.3.0

- Phoneme レイヤーの複数配置に対応
- 再生位置に Phoneme レイヤーを配置するよう変更
- セリフの長さでレイヤーが作成されるように変更
- 一部軽量化

### v0.4.0

- デフォルトレイヤー機能を追加（`def`）
